<!doctype html>
<html>
    <head>
        <!---- LINKS ---->
        <link rel="stylesheet" type="text/css" href="style.css">
        <link href='https://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
        <script src="script/socket.io.js"></script>

        <script>
        var socket = io();
        var myToken, myStream;
        var dataPack = {};
        var socketReady = false;
        var testBox;

        window.addEventListener('load',function(){

            //init
            setTimeout(function(){
                myToken = socket.id;
                socketReady = true;

                //Token_Ready!!_Then_Setup_Socket_KeyWord//
                socket.on( myToken, function(stream){
                console.log("Stream is here");
                yourVideo.src = stream;
                });

            },100);

            testBox = document.getElementById('testBox');


        });

        //registration_for_server_position
        socket.on('testType', function(){
            socket.emit('newArtist','');
        });

        socket.on('deny', function(){
            console.log("You don't a friend!!!");
        });

        //receive_data_stream

        // socket.on( "test", function(stream){
        //     testBox.innerHTML += stream;
        // });
  
        </script>

        <script type="text/javascript">

            var context;
            var canvas;
            var myvideo;
            var points = [];
            var mousePress = false;
            var canvasRect;
            var imageScreen;
            var px = 0;
            var py = 0; 

        //set colors
            var r = 255 * Math.random();
            var g = 255 * Math.random();
            var b = 255 * Math.random();
            var color = "rgb(" + Math.floor(r) + "," + Math.floor(g) + "," + Math.floor(b) + ")";
            //console.log("Color: " + color);

        // shim for cross-browser functionality
            window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;

            var reqAnimFrame = window.mozRequestAnimationFrame    ||
                           window.webkitRequestAnimationFrame ||
                           window.msRequestAnimationFrame     ||
                           window.onRequestAnimationFrame
                           ;
            
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;



            function init(){

        //-----LOAD USER VIDEO INPUT-----//

                //console.log("Init!");
                myvideo = document.getElementById("videoOfMe");

                if (navigator.getUserMedia) {
                    console.log("in navigator.getUserMedia");
                    navigator.getUserMedia({video: true},
                        function(stream) {
                            console.log("Got success callback");
                            myvideo.src = window.URL.createObjectURL(stream) || stream;
                            myvideo.play();
                        },
                        function(error) {
                            console.log("ERRRRRRRRR");                  
                        });
                }

        //-----CANVAS------//

                canvas = document.getElementById('mycanvas');
                context = canvas.getContext('2d');

                // User presses mouse to draw
                canvas.addEventListener('mousedown', function() {
                    mousePress = true;
                });

                canvas.addEventListener('mouseup', function(){
                    mousePress = false;
                });

                canvas.addEventListener('mousemove', function(e){
                    if(mousePress){
                        canvasRect = canvas.getBoundingClientRect();

                        //console.log(e);
                        x = e.clientX - canvasRect.left;
                        y = e.clientY - canvasRect.top;
                        console.log("x: " + x + " y:" + y);
                        points.push({x: x, y: y});
                   }
                 });

                function draw() {

                    //load my video into canvas
                    context.drawImage(myvideo, 0, 0);
                    //var candata = canvas.toDataURL('image/webp', 1);
                    //console.log(candata);

                    //load partner's video into my canvas
                    //context.drawImage(partnervideo, 0, 0);


                    for (var i = 0; i < points.length; i++) {

                        context.beginPath();
                        context.strokeStyle = color;
                        context.moveTo(px, py);
                        context.lineTo(points[i].x,points[i].y);
                        context.stroke();
                        //context.arc(points[i].x, points[i].y, 5, 0, 2 * Math.PI, false);
                        //context.fillStyle = color;
                        //context.fill();

                        px = points[i].x;
                        py = points[i].y;
                    }

                    if(socketReady){

                        myStream = canvas.toDataURL('image/webp', 1);

                            dataPack = {
                                token : myToken,
                                stream : myStream
                            }

                            socket.emit('frame', dataPack);

                            //console.log(dataPack);

                     }

                    reqAnimFrame(draw);
                }

                draw();


                imageScreen = document.getElementById('yourVideo');

            }

            




            window.addEventListener('load', init);
        </script>
    
    </head>

    <body>

        <!--div>
        You Can Remove "testBox" div After Testing
        For Testing: Type AnyTing Runtime
        Rubin
        <div-->
        <!--<div id = "testBox" >
        </div>-->

        <div class="main">
        <header>
            <h1>Drawing on Everyone</h1>
        </header>

        <div id="drawbox">
            <video id="videoOfMe" height="480" width="640"></video>
            <canvas id="mycanvas" height="480" width="640"/>
        </div><!--close drawbox-->

        <img src="" id="yourVideo" height="480" width="640"/>

        <div class="button">
            Send
        </div><!--close button-->

        <div id="gallery">
            <h2>Drawings on me</h2>

            <ul id="gallerylist">
                <li class="mypics">
                </li>
            </ul>
        </div><!--close gallery-->
    </div><!--close main-->

    </body>
</html>